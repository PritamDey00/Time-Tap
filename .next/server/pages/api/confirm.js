"use strict";(()=>{var e={};e.id=4750,e.ids=[4750],e.modules={8432:e=>{e.exports=require("bcryptjs")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1721:e=>{e.exports=import("@upstash/redis")},3292:e=>{e.exports=require("fs/promises")},1017:e=>{e.exports=require("path")},6450:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>d,routeModule:()=>p});var i=r(1802),o=r(7153),s=r(6249),a=r(6791),u=e([a]);a=(u.then?(await u)():u)[0];let d=(0,s.l)(a,"default"),l=(0,s.l)(a,"config"),p=new i.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/confirm",pathname:"/api/confirm",bundlePath:"",filename:""},userland:a});n()}catch(e){n(e)}})},6791:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>handler});var i=r(9344),o=r.n(i),s=r(8936),a=e([s]);s=(a.then?(await a)():a)[0];let u=process.env.JWT_SECRET||"dev-secret";async function handler(e,t){let r;if("POST"!==e.method){t.status(405).json({error:"Method not allowed"});return}let n=e.headers.cookie||"",i=n.split(";").map(e=>e.trim()).find(e=>e.startsWith("auth="));if(!i){t.status(401).json({error:"Not authenticated"});return}let a=i.split("=")[1];try{r=o().verify(a,u)}catch(e){t.status(401).json({error:"Invalid token"});return}let d=await (0,s.GG)(r.name);if(!d){t.status(404).json({error:"User not found"});return}let l=new Date,p=l.getMinutes(),f=l.getSeconds(),c=0===p&&f<60,m=30===p&&f<60,w="admin"===d.name;if(!c&&!m&&!w){t.status(400).json({error:"Outside confirmation window. Next window opens at :00 or :30 of the hour.",nextWindow:p<30?":30":":00 (next hour)"});return}let h=d.lastConfirm?new Date(d.lastConfirm):null;if(h){let e=h.getHours(),r=h.getMinutes(),n=l.getHours();if(e===n&&(c&&0===r||m&&30===r)){t.status(400).json({error:"Already confirmed in this window. Wait for next confirmation window.",nextWindow:c?":30":":00 (next hour)"});return}}let x=1,g=1;if(h&&d.streak>0){let e=l.getTime()-h.getTime();e<=39e5&&(x=2,g=d.streak+1)}d.points=(d.points||0)+x,d.streak=g,d.lastConfirm=l.toISOString();let k=await (0,s.Nq)(d);t.json({user:{id:k.id,name:k.name,points:k.points,streak:k.streak,lastConfirm:k.lastConfirm},pointsAwarded:x,windowType:c?":00 window":":30 window"})}n()}catch(e){n(e)}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[4222,7316,8936],()=>__webpack_exec__(6450));module.exports=r})();